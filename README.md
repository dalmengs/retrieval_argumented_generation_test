# 검색증강생성(RAG) 테스트

* 검색증강생성(Retrieval Argumented Generation, RAG)는 어떤 쿼리에 대해 문서 안에서 문맥적으로 유사한 정보를 검색하는 것이다.
* GPT와 같은 언어 모델을 메인으로 사용하기 보다는, 벡터 데이터베이스(VDB)와 같은 외부 도구를 활용하여 더욱 정확하고 다양한 정보를 찾을 수 있다.

<hr>

* 본 프로젝트에서는 벡터 데이터베이스와 임베딩 모델을 활용하여  문맥적으로 유사한 정보를 더 잘 가져오는 방법을 탐구하는 것을 목표로 한다.
* 대화 데이터를 만들고, 그 요약본을 벡터 데이터베이스에 넣은 뒤, 여러 테스트케이스에 대해 벡터 데이터베이스에 있는 데이터를 결과로 하여 테스트케이스와 결과가 문맥적으로 유사한지 판단하는 방법으로 진행한다.

<hr>

* 본 프로젝트의 대화 데이터 개수는 50개이다.
* 한 대화 당 세 개의 요약을 생성한다.
* 한 대화 당 테스트케이스의 개수는 10개이다.
* 즉 500개의 테스트케이스에 대해, 테스트케이스와 RAG 결과가 같은 대화에서 추출되었다면 성공, 그렇지 않으면 실패로 간주한다.
* 본 프로젝트에서 실험할 다섯 가지 방법은 아래와 같다.

<hr>

### [방법 1] 여러 개의 요약을 한 문장으로 
세 개의 요약을 단순하게 한 문장으로 합쳐 벡터 데이터베이스에 넣는다.

$V = Embedding(s1 + s2 + s3)$

<hr>

### [방법 2] 세 벡터의 평균을 임베딩 벡터
세 개가 어차피 같은 문맥(Context)에서 나온 벡터이므로 가중치 없이 세 벡터의 평균을 임베딩 벡터로 사용한다.

$V = \frac {V_1 + V_2 + V_3}{3}$

<hr>

### [방법 3] 가중치를 부여하도록 
중요한 만큼 가중치(Weight)를 설정하여 더 중요한 벡터는 더 반영하도록 한다.

$V = \sum_{i=1}^3 (w_i \times V_i)$

<hr>

### [방법 4] 언어 모델에게 선택하도록 
세 개의 요약 중 문맥적으로 유사한 것을 언어 모델이 선택하도록 한다.

$V = LLM(V_1, \,V_2, \,V_3)$

<hr>

### [방법 5] 동적으로 테스트케이스를 만들어 Retrieval Test로 Best Vector 선택
1. 세 요약본에 대하여 LLM에게 10개 정도의 테스트케이스를 만들도록 지시
2. 발화 쿼리와 테스트케이스의 코사인 유사도(Cosine Similarity)를 계산함
3. 코사인 유사도가 임계치를 넘는 벡터에 대해서 <strong>[방법 2]</strong>, <strong>[방법 3]</strong>을 활용하거나, 코사인 유사도가 가장 높은 벡터를 임베딩 벡터로 사용함

<hr>

### 테스트 환경 구축

* Python3이 설치되어 있어야 한다.
* Docker가 설치되어 있어야 한다. (For Milvus, Vector Database)

<hr>

### 1. 환경 변수와 프롬프트 준비하기

* `.env_template`를 보고 환경 변수 파일(`.env`)을 만든다.
* 프롬프트를 작성한다. 프롬프트는 `..._example.md` 형식으로 되어있는 예시 프롬프트를 활용한다.
    * `generate_chat_prompt.md` 
    * `generate_summary_prompt.md` 
    * `generate_test_data_prompt.md` 

#### [참고]
* 프롬프트는 비공개하였다.
* 실제 프롬프트는 모두 영어로 작성되었고, 프롬프트 당 150 ~ 200 토큰 정도로 작성되었다.
* `Few shot prompting` 기법을 활용하였다.

<hr>

### 2. 데이터 파일 만들기

아래 세 개의 명령을 실행하여 실험을 위한 테스트 데이터를 만든다.

```bash
python generate_chat.py
python generate_summary.py
python generate_test_data.py
```

* `generate_chat.py`는 테스트 대화 데이터를 만든다.
* `generate_summary.py`는 대화 데이터로 요약 데이터를 만든다.
* `generate_test_data.py`는 요약 데이터로 테스트 데이터를 만든다.

<hr>

### 3. 데이터 파일 테스트하기 

```bash
python generated_data_check.py
```

* 테스트 대화 / 요약 / 테스트 데이터가 잘 생성되었는지 확인한다.

<hr>

### ... 추후 진행 예정 